{% extends 'base.html' %}
{% load static %}
{%block content%}
	<div class="izq">
		<a href="{% url 'editar_activo' activo.TAid %}" class="btn btn-warning sep font-weight-bold"><i class="far fa-edit"></i> Editar</a>
		<a href="{% url 'eliminar_activo' activo.TAid %}" class="btn btn-danger sep font-weight-bold"><i class="fas fa-minus-circle"></i> Eliminar</a>
		<a href="{% url 'lista_activos' %}" class="btn btn-dark sep font-weight-bold"><i class="fas fa-arrow-circle-left"></i> Volver a Lista de Activos</a>
	</div>
	<h2>#{{activo.TAid}} {{activo.nombre}}</h2>
	
	<div>
		<p>Responsable de Seguridad: {{activo.rs}}<p>
		<p>Tipo de Activo: {{activo.tipoactivo}}</p>
		<p>Nombre Activo: {{activo.nombre}}</p>
		<p>Descripción del activo: {{activo.descripcion}}</p>
		<p>Propietario del Activo: {{activo.propietario}}</p>
		<p>Ubicación del Activo: {{activo.ubicacion}}</p>
		<p>Valor de Riesgo del activo: {{activo.valor}}</p>	
		<p>{{activo.date}}</p>
		<p><a href="{{activo.informe_url|default_if_none:'#'}}" class="btn btn-dark link-b" target="_blank">Ver informe <i class="far fa-file"></i></a></p>
	</div>
    <hr>
	<div class="der">
		<a href="{% url 'nueva_amenaza' activo.TAid %}" class="btn btn-success ag-mr-05 font-weight-bold"><i class="fas fa-plus-circle"></i> Añadir Amenaza</a>
        <button id="ag-bot" type="button" class="btn btn-info sep"><i class="far fa-eye-slash"></i> Ocultar Lista Amenazas</button>
	</div> 
<ul id="ag-tab">
    <table class="table table-hover table-striped tab_resp">
        <thead>
        <tr>
            <th scope="col">#ID</th>
            <th scope="col">ID Activo</th>
            <th scope="col">Activo</th>
            <th scope="col">Amenaza</th>
            <th scope="col">Probabilidad</th>
            <th scope="col">Impacto</th>
            <th scope="col">Riesgo</th>
            <th scope="col">Ver Detalles</th>
            <th scope="col">Editar</th>
            <th id="lad" scope="col">Eliminar</th>
        </tr>
        </thead>
        <tbody>
        {% for amenaza in amenaza_activos %}
            <tr>
                <th scope="row"><a href="{% url 'detalle_amenaza' amenaza.id_Amenaza %}" class="cnegro">{{amenaza.id_Amenaza}}</a></th>             
                <td>{{amenaza.activo.TAid}}</td>
                <td>{{amenaza.activo}}</td>
                <td>{{amenaza.amenaza}}</td>
                <td>{{amenaza.probabilidad}}</td>
                <td>{{amenaza.impacto}}</a></td>
                <td id="riesgo" class="riesgo">{{amenaza.riesgo}}</td>
                <td><a href="{% url 'detalle_amenaza' amenaza.id_Amenaza %}" class="cnegro"><i class="far fa-eye"></i></a></td>
                <td><a href="{% url 'editar_amenaza' amenaza.id_Amenaza %}" class="camarillo icono"><i class="far fa-edit"></i></a></td>
                <td><a href="{% url 'eliminar_amenaza' amenaza.id_Amenaza %}" class="crojo icono"><i class="far fa-trash-alt"></i></a></td>
            </tr>
        {% endfor %}
        <h2>historico</h2>
        <!-- Recorrer todo el historico de amenazas y encontrar coincidencias en el ID de HISTORICO_ULTIMOS -->
        <!-- Falta agregar valor por defecto para los valores que no se encuentran en la lista -->
        {% for i in historico_amenaza %}
            {%for x in historico_ultimos%}
                {% if i.id == x.id__max %}
                    <p>ID Amenaza: {{i.id_f_amenaza}} Riesgo: {{i.riesgo}} id : {{i.id}}</p>
                {% endif %}
            {%endfor%}
        {% endfor %}
        </tbody>
        </table>
</ul>   
	<section style="width:70%; margin:auto;">
		<canvas id="analisis"></canvas>
	</section>
    <script>
            mostrarListaAmenazas();
            valorRiesgo();
            // Grafico
            let ctx = document.getElementById('analisis').getContext('2d');
            let myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [
                    {% for amenaza in amenaza_activos %}
                        '{{amenaza.amenaza}}',
                    {%endfor%}],
                    datasets: [
                    {
                        label:'Riesgo Anterior',
                        data:[ {% for i in historico_amenaza %}
                                {%for x in historico_ultimos%}
                                    {% if i.id == x.id__max %}
                                        {{i.riesgo}},
                                    {% endif %}
                                {%endfor%}
                            {% endfor %}],
                        lineTension:0,
                        borderColor: 'rgba(160, 160, 160,1)',
                        fill:false,
                        borderWidth: 1
                
                    },
                    {
                        label: 'Riesgo Actual',
                        data: [{% for amenaza in amenaza_activos %}
                            {{amenaza.riesgo}},
                        {%endfor%}],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                        ],
                        fill:false,

                        pointBackgroundColor: [
                        {% for amenaza in amenaza_activos %}
                            'rgba(222, 99, 132, 1)',
                        {%endfor%}],
                        lineTension:0
                    }
                    ]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                min: 0, 
                                max: 9,
                            }
                        }]
                    }
                }
            });
        </script>
{%endblock content%}